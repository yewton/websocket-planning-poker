@(roomNumber: Int, userName: String)(implicit request: RequestHeader)

@main(Some(userName)) {
    
    <div class="page-header">
        <h1>Welcome to the chat room <small>You are chatting as @userName</small></h1>
    </div>
    
    <div id="onError" class="alert-message error">
        <p>
            <strong>Oops!</strong> <span></span>
        </p>
    </div>
    
    <div id="onChat" class="row">
        <div class="span10" id="main">
            <div id="messages">
            </div>
            <textarea id="talk"></textarea>
        </div>
        <div class="span4">
            <h2>Members</h2>
            <ul id="members">
            </ul>
        </div>
    </div>
    
    <script type="text/javascript" charset="utf-8">
    
        $(function() {
            
			var WS = window['MozWebSocket'] ? MozWebSocket : WebSocket;
            var chatSocket = new WS("@routes.Application.socket(roomNumber, userName).webSocketURL()");
            
            var sendMessage = function(kind, obj) {
                chatSocket.send(JSON.stringify(
                    {
                        kind: kind,
                        body: obj
                    }
                ));
            };

            var talk = function() {
                sendMessage("talk", $("#talk").val());
                $("#talk").val('');
            };

            var members = function() {
                sendMessage("members", {})
            };
            
            var receiveEvent = function(event) {
                var data = JSON.parse(event.data);
                
                // Handle errors
                if(data.error) {
                    chatSocket.close();
                    $("#onError span").text(data.error);
                    $("#onError").show();
                    return;
                } else {
                    $("#onChat").show();
                }

                var kind = data.kind;
                var user = data.user;
                var body = data.body;
                handleMessage(kind, user, body);
            }

            var handleMessage = function(kind, user, body) { switch(kind) {
                case "talk": case "join": case "quit":
                    // Create the message element
                    var el = $('<div class="message"><span></span><p></p></div>');
                    $("span", el).text(user);
                    $("p", el).text(body);
                    $(el).addClass(kind);
                    if(user == '@userName') $(el).addClass('me');
                    $('#messages').append(el);
                    switch(kind) {
                        case "join": case "quit":
                            members();
                            break;
                    }
                    break;
                case "members":
                    // Update the members list
                    $("#members").html('');
                    $(body).each(function() {
                        $("#members").append('<li>' + this + '</li>')
                    });
                    break;
            }}
            
            var handleReturnKey = function(e) {
                if(e.charCode == 13 || e.keyCode == 13) {
                    e.preventDefault()
                    talk()
                } 
            }
            
            $("#talk").keypress(handleReturnKey)
            
            chatSocket.onmessage = receiveEvent
            chatSocket.onopen = function () { members(); }
        })
    
    </script>
    
}
